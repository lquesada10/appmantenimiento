<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Mini-App | Reportar Problema</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: auto;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <h2>✉️ Reportar un Problema</h2>
    <form id="form">
      <label><strong>Tienda:</strong></label><br />
      <select id="tienda" required>
        <option value="">Selecciona una tienda</option>
        <option value="Tienda 1">Tienda 1</option>
        <option value="Tienda 2">Tienda 2</option>
        <option value="Tienda 3">Tienda 3</option>
      </select><br /><br />

      <label><strong>Tipo de problema:</strong></label><br />
      <input id="tipo" required /><br /><br />

      <label><strong>Prioridad:</strong></label><br />
      <select id="prioridad" required>
        <option value="">Selecciona prioridad</option>
        <option value="Alta">Alta</option>
        <option value="Media">Media</option>
        <option value="Baja">Baja</option>
      </select><br /><br />

      <label><strong>Descripción:</strong></label><br />
      <textarea id="descripcion" required></textarea><br /><br />

      <label><strong>Subir evidencia (hasta 6 archivos):</strong></label><br />
      <input id="evidencia" type="file" multiple accept="image/*,application/pdf" /><br /><br />

      <label><strong>Nombre del Supervisor:</strong></label><br />
      <select id="supervisor" required>
        <option value="">Selecciona supervisor</option>
        <option value="Pedro">Pedro</option>
        <option value="Liliana">Liliana</option>
      </select><br /><br />

      <label><strong>Técnico asignado:</strong></label><br />
      <select id="tecnico" required>
        <option value="">Selecciona técnico</option>
        <option value="Juan">Juan</option>
        <option value="Luis">Luis</option>
      </select><br /><br />

      <button type="submit">Enviar reporte</button>
    </form>

    <script>
  const form = document.getElementById("form");
  const input = document.getElementById("evidencia");
  const appsScriptURL = "https://script.google.com/macros/s/AKfycbwysvw9MeaO8xrK1sZAqJ7GidxXhrd1c17jrfAPOgZm1r4ZLmwAkD01drVBnuShgAyQ/exec";
  const makeWebhook = "https://hook.us2.make.com/u5jtibpupivqha6xjm40w7eoty3ufy";

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      const files = input.files;
      if (files.length > 6) {
        alert("Máximo 6 archivos.");
        return;
      }

      const fileData = [];
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const base64 = await toBase64(file);
        fileData.push({
          content: base64.split(",")[1],
          type: file.type,
          name: file.name
        });
      }

      const uploadForm = new FormData();
      uploadForm.append("fileCount", fileData.length);
      fileData.forEach((file, i) => {
        uploadForm.append(`file${i + 1}`, file.content);
        uploadForm.append(`mimeType${i + 1}`, file.type);
        uploadForm.append(`fileName${i + 1}`, file.name);
      });

      // Paso 1: Subir archivos a Drive
      const uploadRes = await fetch(appsScriptURL, {
        method: "POST",
        body: uploadForm
      });

      const { links } = await uploadRes.json();

      // Paso 2: Enviar todo a Make con links de evidencia
      const data = {
        fecha: new Date().toISOString(),
        tienda: document.getElementById("tienda").value,
        tipoProblema: document.getElementById("tipo").value,
        prioridad: document.getElementById("prioridad").value,
        descripcion: document.getElementById("descripcion").value,
        evidencia: links.join(" | "),
        supervisor: document.getElementById("supervisor").value,
        tecnicoAsignado: document.getElementById("tecnico").value
      };

      await fetch(makeWebhook, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      alert("Reporte enviado con éxito");
      form.reset();
    } catch (err) {
      console.error("ERROR", err);
      alert("Error al enviar. Revisa consola (F12).");
    }
  });

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
    });
  }
</script>

  </body>
</html>
